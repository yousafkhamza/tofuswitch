#!/bin/bash

# tofuswitch - A version switcher for OpenTofu
# Inspired by tfswitch, but specifically for OpenTofu

set -e

# Configuration
TOFU_INSTALL_DIR="${TOFU_INSTALL_DIR:-$HOME/.tofu/versions}"
TOFU_CURRENT_SYMLINK="${TOFU_CURRENT_SYMLINK:-$HOME/.tofu/current}"
GITHUB_RELEASES_URL="https://github.com/opentofu/opentofu/releases/download"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Ensure installation directories exist
mkdir -p "$TOFU_INSTALL_DIR"
mkdir -p "$(dirname "$TOFU_CURRENT_SYMLINK")"

# Function to list installed versions
list_installed_versions() {
    echo -e "${YELLOW}Installed OpenTofu versions:${NC}"
    if [ -d "$TOFU_INSTALL_DIR" ]; then
        local versions=$(ls "$TOFU_INSTALL_DIR" 2>/dev/null)
        if [ -z "$versions" ]; then
            echo "No versions installed."
        else
            for version in $versions; do
                # Strip 'tofu_' prefix and check if current version
                clean_version=${version#tofu_}
                if [ "$(readlink "$TOFU_CURRENT_SYMLINK")" == "${TOFU_INSTALL_DIR}/${version}/tofu" ]; then
                    echo -e "${GREEN}* ${clean_version} (current)${NC}"
                else
                    echo "  ${clean_version}"
                fi
            done
        fi
    else
        echo "No versions installed."
    fi
}

# Function to get installed versions as a list
get_installed_versions() {
    ls "$TOFU_INSTALL_DIR" 2>/dev/null | sed 's/tofu_//'
}

# Function to fetch and display available versions
fetch_available_versions() {
    echo -e "${YELLOW}Available OpenTofu versions:${NC}"
    local versions=$(curl -s https://api.github.com/repos/opentofu/opentofu/releases \
        | grep '"tag_name":' \
        | sed -E 's/.*"v?([^"]+)".*/\1/' \
        | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$')
    
    if [ -z "$versions" ]; then
        echo -e "${RED}Failed to fetch versions from GitHub.${NC}"
        exit 1
    fi
    
    echo "$versions"
}

# Function to remove a version
remove_version() {
    local version="$1"
    local target_dir="${TOFU_INSTALL_DIR}/tofu_${version}"

    # If no version specified, show installed versions and guide user
    if [ -z "$version" ]; then
        echo -e "${YELLOW}Please specify a version to remove.${NC}"
        echo "Available installed versions:"
        list_installed_versions
        echo -e "\nUsage: tofuswitch remove <version>"
        exit 1
    fi

    if [ ! -d "$target_dir" ]; then
        echo -e "${RED}Version ${version} is not installed.${NC}"
        echo "Available installed versions:"
        list_installed_versions
        exit 1
    fi

    # Check if this is the current version
    if [ "$(readlink "$TOFU_CURRENT_SYMLINK")" == "${target_dir}/tofu" ]; then
        echo -e "${YELLOW}Cannot remove the current version. Switch to another version first.${NC}"
        exit 1
    fi

    rm -rf "$target_dir"
    echo -e "${GREEN}Removed OpenTofu v${version}.${NC}"
}

# Function to add shell autocompletion
_tofuswitch_completions() {
    local cur prev opts
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"

    # Available commands
    local commands="list available install remove current latest help"

    # Subcommand completion
    case "${prev}" in
        install|remove)
            # Combine remote versions with locally installed versions
            local remote_versions=$(curl -s https://api.github.com/repos/opentofu/opentofu/releases \
                | grep '"tag_name":' \
                | sed -E 's/.*"v?([^"]+)".*/\1/' \
                | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$')
            
            # Add locally installed versions for remove command
            local installed_versions=$(get_installed_versions)
            
            if [ "${prev}" = "remove" ]; then
                # For remove, only suggest locally installed versions
                COMPREPLY=( $(compgen -W "${installed_versions}" -- "${cur}") )
            else
                # For install, suggest all versions
                COMPREPLY=( $(compgen -W "${remote_versions}" -- "${cur}") )
            fi
            return 0
            ;;
    esac

    # Main command completion
    COMPREPLY=( $(compgen -W "${commands}" -- "${cur}") )
    return 0
}

# Register autocompletion
complete -F _tofuswitch_completions tofuswitch

# Main script logic
case "$1" in
    list)
        list_installed_versions
        ;;
    available)
        fetch_available_versions
        ;;
    install)
        if [ -z "$2" ]; then
            fetch_available_versions
            exit 0
        fi
        install_version "$2"
        ;;
    remove)
        remove_version "$2"
        ;;
    current)
        if [ -L "$TOFU_CURRENT_SYMLINK" ]; then
            readlink "$TOFU_CURRENT_SYMLINK" | sed 's/.*tofu_\([^/]*\).*/\1/'
        else
            echo -e "${RED}No current OpenTofu version set.${NC}"
        fi
        ;;
    latest)
        install_version latest
        ;;
    help|*)
        echo "tofuswitch - OpenTofu Version Manager"
        echo "Usage:"
        echo "  $0 list           # List installed versions"
        echo "  $0 available      # List and select available versions"
        echo "  $0 install <ver>  # Install specific version (or latest)"
        echo "  $0 latest         # Install latest stable version"
        echo "  $0 remove <ver>   # Remove specific version"
        echo "  $0 current        # Show current version"
        exit 1
        ;;
esac