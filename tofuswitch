#!/bin/bash

# tofuswitch - A version switcher for OpenTofu
# Inspired by tfswitch, but specifically for OpenTofu

set -e

# Configuration
TOFU_INSTALL_DIR="${TOFU_INSTALL_DIR:-$HOME/.tofu/versions}"
TOFU_CURRENT_SYMLINK="${TOFU_CURRENT_SYMLINK:-$HOME/.tofu/current}"
GITHUB_RELEASES_URL="https://github.com/opentofu/opentofu/releases/download"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Ensure installation directories exist
mkdir -p "$TOFU_INSTALL_DIR"
mkdir -p "$(dirname "$TOFU_CURRENT_SYMLINK")"

# Function to list installed versions
list_installed_versions() {
    echo -e "${YELLOW}Installed OpenTofu versions:${NC}"
    if [ -d "$TOFU_INSTALL_DIR" ]; then
        local versions=$(ls "$TOFU_INSTALL_DIR" 2>/dev/null)
        if [ -z "$versions" ]; then
            echo "No versions installed."
        else
            for version in $versions; do
                # Strip 'tofu_' prefix and check if current version
                clean_version=${version#tofu_}
                if [ "$(readlink "$TOFU_CURRENT_SYMLINK")" == "${TOFU_INSTALL_DIR}/${version}/tofu" ]; then
                    echo -e "${GREEN}* ${clean_version} (current)${NC}"
                else
                    echo "  ${clean_version}"
                fi
            done
        fi
    else
        echo "No versions installed."
    fi
}

# Function to get installed versions as a list
get_installed_versions() {
    ls "$TOFU_INSTALL_DIR" 2>/dev/null | sed 's/tofu_//'
}

# Function to get the latest version
get_latest_version() {
    local versions=$(curl -s https://api.github.com/repos/opentofu/opentofu/releases \
        | grep '"tag_name":' \
        | sed -E 's/.*"v?([^"]+)".*/\1/' \
        | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' \
        | sort -V -r \
        | head -n 1)
    
    if [ -z "$versions" ]; then
        echo -e "${RED}Failed to fetch versions from GitHub.${NC}"
        exit 1
    fi
    
    echo "$versions"
}

# Function to fetch and display available versions
fetch_available_versions() {
    echo -e "${YELLOW}Available OpenTofu versions:${NC}"
    # Fetch and sort versions
    local versions
    versions=$(curl -s https://api.github.com/repos/opentofu/opentofu/releases \
        | grep '"tag_name":' \
        | sed -E 's/.*"v?([^"]+)".*/\1/' \
        | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' \
        | sort -V -r)
    
    if [ -z "$versions" ]; then
        echo -e "${RED}Failed to fetch versions from GitHub.${NC}"
        exit 1
    fi

    # Show all versions if --all flag is used
    if [ "$1" == "--all" ]; then
        echo "$versions"
        return
    fi

    # Create array of versions
    mapfile -t version_array <<< "$versions"
    
    # Show latest 5 versions with numbers
    echo "Latest versions (select a number to install):"
    for i in {0..4}; do
        if [ -n "${version_array[$i]}" ]; then
            echo -e "$((i+1)). ${GREEN}${version_array[$i]}${NC}"
        fi
    done
    echo "6. Show all versions"
    echo -n "Enter number (1-6) or press Ctrl+C to cancel: "
    read selection

    case $selection in
        [1-5])
            local selected_version="${version_array[$((selection-1))]}"
            if [ -n "$selected_version" ]; then
                echo -e "\nInstalling OpenTofu version ${GREEN}${selected_version}${NC}"
                install_version "$selected_version"
            else
                echo -e "${RED}Invalid selection${NC}"
                exit 1
            fi
            ;;
        6)
            echo -e "\nAll available versions:"
            echo "$versions"
            ;;
        *)
            echo -e "${RED}Invalid selection${NC}"
            exit 1
            ;;
    esac
}

# Function to remove a version
remove_version() {
    local version="$1"
    local target_dir="${TOFU_INSTALL_DIR}/tofu_${version}"

    # If no version specified, show installed versions and guide user
    if [ -z "$version" ]; then
        echo -e "${YELLOW}Please specify a version to remove.${NC}"
        echo "Available installed versions:"
        list_installed_versions
        echo -e "\nUsage: tofuswitch remove <version>"
        exit 1
    fi

    if [ ! -d "$target_dir" ]; then
        echo -e "${RED}Version ${version} is not installed.${NC}"
        echo "Available installed versions:"
        list_installed_versions
        exit 1
    fi

    # Check if this is the current version
    if [ "$(readlink "$TOFU_CURRENT_SYMLINK")" == "${target_dir}/tofu" ]; then
        echo -e "${YELLOW}Cannot remove the current version. Switch to another version first.${NC}"
        exit 1
    fi

    rm -rf "$target_dir"
    echo -e "${GREEN}Removed OpenTofu v${version}.${NC}"
}

# Function to add shell autocompletion
_tofuswitch_completions() {
    local cur prev opts
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"

    # Available commands
    local commands="list available install remove current latest help"

    # Subcommand completion
    case "${prev}" in
        install|remove)
            # Combine remote versions with locally installed versions
            local remote_versions=$(curl -s https://api.github.com/repos/opentofu/opentofu/releases \
                | grep '"tag_name":' \
                | sed -E 's/.*"v?([^"]+)".*/\1/' \
                | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$')
            
            # Add locally installed versions for remove command
            local installed_versions=$(get_installed_versions)
            
            if [ "${prev}" = "remove" ]; then
                # For remove, only suggest locally installed versions
                COMPREPLY=( $(compgen -W "${installed_versions}" -- "${cur}") )
            else
                # For install, suggest all versions
                COMPREPLY=( $(compgen -W "${remote_versions}" -- "${cur}") )
            fi
            return 0
            ;;
    esac

    # Main command completion
    COMPREPLY=( $(compgen -W "${commands}" -- "${cur}") )
    return 0
}

# Register autocompletion
complete -F _tofuswitch_completions tofuswitch

# Function to install a version
install_version() {
    local version="$1"
    local target_dir="${TOFU_INSTALL_DIR}/tofu_${version}"
    local download_url="${GITHUB_RELEASES_URL}/v${version}/tofu_${version}_linux_amd64.tar.gz"

    # Check if version is already installed
    if [ -d "$target_dir" ]; then
        echo -e "${YELLOW}OpenTofu v${version} is already installed.${NC}"
        return
    fi

    # Download and extract version
    echo -e "\nDownloading OpenTofu v${version}..."
    curl -s -L "$download_url" | tar -xz -C "$TOFU_INSTALL_DIR"

    # Set current version if not already set
    if [ ! -L "$TOFU_CURRENT_SYMLINK" ]; then
        ln -s "$target_dir/tofu" "$TOFU_CURRENT_SYMLINK"
    fi

    echo -e "${GREEN}Installed OpenTofu v${version}.${NC}"
}

# Main script logic
case "$1" in
    list)
        list_installed_versions
        ;;
    available)
        if [ "$2" == "--all" ]; then
            fetch_available_versions --all
        else
            fetch_available_versions
        fi
        ;;
    install)
        if [ -z "$2" ]; then
            fetch_available_versions
            exit 0
        fi
        install_version "$2"
        ;;
    remove)
        remove_version "$2"
        ;;
    current)
        if [ -L "$TOFU_CURRENT_SYMLINK" ]; then
            readlink "$TOFU_CURRENT_SYMLINK" | sed 's/.*tofu_\([^/]*\).*/\1/'
        else
            echo -e "${RED}No current OpenTofu version set.${NC}"
        fi
        ;;
    latest)
        echo -e "${YELLOW}Installing latest version of OpenTofu...${NC}"
        latest_version=$(get_latest_version)
        if [ -n "$latest_version" ]; then
            install_version "$latest_version"
        fi
        ;;
    help|*)
        echo "tofuswitch - OpenTofu Version Manager"
        echo "Usage:"
        echo "  $0 list           # List installed versions"
        echo "  $0 available      # List and select available versions"
        echo "  $0 install <ver>  # Install specific version (or latest)"
        echo "  $0 latest         # Install latest stable version"
        echo "  $0 remove <ver>   # Remove specific version"
        echo "  $0 current        # Show current version"
        exit 1
        ;;
esac